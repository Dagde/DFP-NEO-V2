// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserStatus {
  active
  disabled
  pending
}

enum Role {
  SUPER_ADMIN
  ADMIN
  PILOT
  INSTRUCTOR
  USER
}

// ============================================================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================================================

model User {
  id                  String        @id @default(cuid())
  
  // Login credentials (NEW: userId is the login identifier, NOT email)
  userId              String        @unique  // Login identifier (e.g., employee ID, service number)
  email               String?       @unique  // Optional, for recovery/notifications only
  passwordHash        String?                // bcrypt hash, null until set
  
  // User information
  displayName         String?
  firstName           String?
  lastName            String?
  
  // Status and permissions
  status              UserStatus    @default(active)
  permissionsRoleId   String
  permissionsRole     PermissionsRole @relation(fields: [permissionsRoleId], references: [id])
  
  // Password management
  mustChangePassword  Boolean       @default(true)
  passwordSetAt       DateTime?
  lastLoginAt         DateTime?
  
  // Legacy fields (keeping for backward compatibility)
  username            String?       @unique  // Deprecated, use userId
  password            String?                // Deprecated, use passwordHash
  role                Role          @default(USER)  // Deprecated, use permissionsRole
  isActive            Boolean       @default(true)  // Deprecated, use status
  
  // Timestamps
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  // Relations
  sessions            Session[]
  accounts            Account[]
  inviteTokens        InviteToken[]
  passwordResetTokens PasswordResetToken[]
  auditLogsAsActor    AuditLog[]    @relation("AuditLogActor")
  auditLogsAsTarget   AuditLog[]    @relation("AuditLogTarget")
  
  // Legacy relations (keeping for backward compatibility)
  schedules           Schedule[]
  settings            UserSettings?
  createdBy           User?         @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdById         String?
  createdUsers        User[]        @relation("UserCreatedBy")
  flightSchedules     FlightSchedule[] @relation("FlightSchedules")
  personnel           Personnel[]   @relation("Personnel")
  aircraft            Aircraft[]    @relation("Aircraft")
  cancellations       CancellationHistory[] @relation("CancellationHistory")
  legacyAuditLogs     LegacyAuditLog[] @relation("LegacyAuditLog")
  
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([permissionsRoleId])
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// PERMISSIONS SYSTEM
// ============================================================================

model PermissionsRole {
  id          String   @id @default(cuid())
  name        String   @unique  // e.g., Administrator, Instructor, Trainee, Programmer, Maintenance
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  capabilities PermissionsRoleCapability[]
  
  @@index([name])
}

model PermissionCapability {
  id          String   @id @default(cuid())
  key         String   @unique  // e.g., "admin:access_panel", "users:manage", "launch:access"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  roles       PermissionsRoleCapability[]
  
  @@index([key])
}

model PermissionsRoleCapability {
  id           String   @id @default(cuid())
  roleId       String
  capabilityId String
  
  role         PermissionsRole      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  capability   PermissionCapability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, capabilityId])
  @@index([roleId])
  @@index([capabilityId])
}

// ============================================================================
// PASSWORD MANAGEMENT
// ============================================================================

model InviteToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique  // SHA-256 hash of the token
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())
  
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model PasswordResetToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique  // SHA-256 hash of the token
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())
  
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id            String   @id @default(cuid())
  actorUserId   String?  // Who performed the action (null for system actions)
  actionType    String   // e.g., "login_success", "login_failure", "user_created", "password_changed"
  targetUserId  String?  // User affected by the action
  metadata      Json?    // Additional context
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  
  actor         User?    @relation("AuditLogActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  target        User?    @relation("AuditLogTarget", fields: [targetUserId], references: [id], onDelete: SetNull)
  
  @@index([actorUserId])
  @@index([targetUserId])
  @@index([actionType])
  @@index([createdAt])
}

// ============================================================================
// LEGACY MODELS (keeping for backward compatibility)
// ============================================================================

model Schedule {
  id          String   @id @default(cuid())
  userId      String
  date        String
  data        Json     // Store the entire schedule data as JSON
  version     String   @default("flight-school")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date, version])
  @@index([userId])
  @@index([date])
}

model UserSettings {
  id          String   @id @default(cuid())
  userId      String   @unique
  settings    Json     // Store all user settings as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DataBackup {
  id          String   @id @default(cuid())
  type        String   // 'schedule', 'settings', 'full'
  data        Json
  createdAt   DateTime @default(now())
  userId      String?
  
  @@index([type])
  @@index([createdAt])
}

model FlightSchedule {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime
  scheduleData Json    // Stores the complete schedule for the day
  version     String   @default("1.0")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation("FlightSchedules", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

model Personnel {
  id              String   @id @default(cuid())
  userId          String
  name            String
  rank            String?
  role            String   // 'instructor', 'trainee', 'staff'
  qualifications  Json?    // Array of qualifications
  availability    Json?    // Availability data
  preferences     Json?    // Scheduling preferences
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation("Personnel", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([role])
  @@index([isActive])
}

model Aircraft {
  id              String   @id @default(cuid())
  userId          String
  aircraftNumber  String   // e.g., "001", "002"
  type            String   // Aircraft type
  status          String   @default("available") // 'available', 'maintenance', 'unavailable'
  configuration   Json?    // Seat configurations, equipment
  maintenanceLog  Json?    // Maintenance history
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation("Aircraft", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([isActive])
  @@unique([userId, aircraftNumber])
}

model CancellationHistory {
  id              String   @id @default(cuid())
  userId          String
  scheduleId      String?
  eventId         String
  eventType       String   // 'flight', 'simulator', etc.
  cancellationCode String
  reason          String?
  cancelledBy     String
  cancelledAt     DateTime @default(now())
  originalData    Json     // Original event data before cancellation
  
  user            User     @relation("CancellationHistory", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([scheduleId])
  @@index([cancelledAt])
  @@index([cancellationCode])
}

// Renamed from AuditLog to avoid conflict
model LegacyAuditLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // 'create', 'update', 'delete', 'login', etc.
  entityType  String   // 'schedule', 'personnel', 'aircraft', etc.
  entityId    String?
  changes     Json?    // What changed
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  user        User     @relation("LegacyAuditLog", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}