import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function fixDuplicateUserIds() {
  console.log('ðŸ”§ Fixing duplicate userIds in Personnel table...\n');

  try {
    // Step 1: Get all personnel records
    const personnel = await prisma.personnel.findMany({
      orderBy: { name: 'asc' }
    });
    console.log(`ðŸ“‹ Found ${personnel.length} personnel records\n`);

    // Step 2: Generate unique userIds based on name pattern or sequence
    const updates = personnel.map((p, index) => {
      // Generate a numeric ID (PMKeys style) - starting from 100001
      const idNumber = 100001 + index;
      const userId = String(idNumber);
      
      return {
        id: p.id,
        newUserId: userId,
        idNumber: idNumber
      };
    });

    console.log('ðŸ”„ Updating personnel records...\n');
    
    // Step 3: Update each record individually
    let successCount = 0;
    for (const update of updates) {
      try {
        await prisma.personnel.update({
          where: { id: update.id },
          data: {
            userId: update.newUserId,
            idNumber: update.idNumber
          }
        });
        successCount++;
        
        if (successCount % 20 === 0) {
          console.log(`âœ… Updated ${successCount}/${updates.length} records...`);
        }
      } catch (error) {
        console.error(`âŒ Failed to update record ${update.id}:`, error);
      }
    }

    console.log(`\nâœ… Successfully updated ${successCount}/${updates.length} records`);
    
    // Step 4: Verify no duplicates remain
    console.log('\nðŸ” Verifying no duplicates remain...');
    const duplicates = await prisma.$queryRaw`
      SELECT "userId", COUNT(*) as count
      FROM "Personnel"
      GROUP BY "userId"
      HAVING COUNT(*) > 1
    `;
    
    if (duplicates.length === 0) {
      console.log('âœ… No duplicate userIds found!');
    } else {
      console.log(`âŒ Still found ${duplicates.length} duplicate userIds`);
    }

    // Step 5: Show sample of updated records
    console.log('\nðŸ“Š Sample of updated records:');
    const sample = await prisma.personnel.findMany({
      take: 5,
      orderBy: { idNumber: 'asc' }
    });
    
    sample.forEach(p => {
      console.log(`   - ${p.name}: userId=${p.userId}, idNumber=${p.idNumber}`);
    });

  } catch (error) {
    console.error('âŒ Fix failed:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

fixDuplicateUserIds()
  .then(() => {
    console.log('\nâœ¨ All done!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\nðŸ’¥ Fatal error:', error);
    process.exit(1);
  });