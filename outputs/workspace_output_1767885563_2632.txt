                        if (countA !== countB) return countA - countB;
                        return a.name.localeCompare(b.name);
                     });
                     
                     candidates = [...primaries, ...others];
                } else {
                    candidates = qualified.sort((a, b) => {
                        const countA = eventCounts.get(a.name)?.flightFtd || 0;
                        const countB = eventCounts.get(b.name)?.flightFtd || 0;
                        if (countA !== countB) return countA - countB;
                        return a.name.localeCompare(b.name);
                    });
                }
            }

            for (const ip of candidates) {
                const eventTypeForCheck = type === 'cpt' ? 'ground' : type;
                if (isPersonStaticallyUnavailable(ip, proposedBookingWindow.start, proposedBookingWindow.end, buildDate, eventTypeForCheck)) continue;
                
                const ipCounts = eventCounts.get(ip.name)!;
                
                // CRITICAL FIX: Check soft duty limit for all instructor assignments
                const proposedEvent = {
                    ...proposedBookingWindow,
                    instructor: ip.name,
                    flightNumber: syllabusItemForCheck.id,
                    type: syllabusItemForCheck.type
                };
                const currentDutyHours = calculateInstructorDutyHours(ip.name, proposedEvent);
                
                if (currentDutyHours > preferredDutyPeriod) {
                    console.log(`SOFT LIMIT VIOLATION: ${ip.name} would exceed ${preferredDutyPeriod}hrs (current: ${currentDutyHours.toFixed(2)}hrs)`);
                    continue;
                }
                
                // NEW RULE: Ground event limits based on Flight/FTD activity
                // If instructor has Flight or FTD events: max 1 ground event
                // If instructor has no Flight or FTD events: max 4 ground events
                if (eventTypeForCheck === 'ground') {
                    const maxGroundEvents = ipCounts.flightFtd > 0 ? 1 : 4;
                    if (ipCounts.ground >= maxGroundEvents) continue;
