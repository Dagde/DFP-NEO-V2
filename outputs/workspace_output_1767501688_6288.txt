    formationCallsigns?: FormationCallsign[];
    currentLocation?: string;
    onVisualAdjustStart?: (event: ScheduleEvent) => void;
    onVisualAdjustEnd?: (event: ScheduleEvent) => void;
    onSavePT051Assessment?: (assessment: any) => void;
    cancellationCodes?: CancellationCode[];
    onCancelEvent?: (eventId: string, cancellationCode: string, manualCodeEntry?: string) => void;
}

interface CrewMember {
    flightType: 'Dual' | 'Solo';
    instructor: string;
    student: string;
    pilot: string;
    group: string;
    groupTraineeIds: number[]; // Added to track selected IDs
}

const getEventTypeFromSyllabus = (syllabusId: string, syllabusDetails: SyllabusItemDetail[]): 'flight' | 'ftd' | 'ground' => {
    const detail = syllabusDetails.find(d => d.id === syllabusId);
    if (!detail) { // Fallback for items not in syllabus like 'SCT FORM' or if data is missing
--
        flightType: event.flightType,
        instructor: event.instructor || '',
        student: event.student || '',
        pilot: event.pilot || '',
        group: event.group || '',
        groupTraineeIds: event.groupTraineeIds || [],
    }]);
    
    console.log('Initial crew state:', crew);

    // Helper function to get Dual/Solo status from Individual LMP
    // Helper function to get Dual/Solo status from Individual LMP
    const getDualSoloFromIndividualLMP = (flightNumber: string, traineeName: string): 'Dual' | 'Solo' => {
        console.log(`ud83dudcdd [getDualSoloFromIndividualLMP] Called with flightNumber: ${flightNumber}, traineeName: ${traineeName}`);
        console.log(`ud83dudcdd [getDualSoloFromIndividualLMP] traineeLMPs available: ${!!traineeLMPs}, traineeLMPs size: ${traineeLMPs?.size || 0}`);
        
        if (!traineeLMPs || !traineeName) {
            console.log(`ud83dudcdd [getDualSoloFromIndividualLMP] Returning 'Dual' - missing traineeLMPs or traineeName`);
            return 'Dual'; // Default to Dual if no data available
        }

        const individualLMP = traineeLMPs.get(traineeName);
        console.log(`ud83dudcdd [getDualSoloFromIndividualLMP] individualLMP found for ${traineeName}:`, !!individualLMP, individualLMP ? individualLMP.length : 0, 'items');
        
        if (!individualLMP) {
            console.log(`ud83dudcdd [getDualSoloFromIndividualLMP] Returning 'Dual' - no Individual LMP found for ${traineeName}`);
            return 'Dual'; // Default to Dual if no Individual LMP found
        }

        const syllabusItem = individualLMP.find(item => 
            item.id === flightNumber || item.code === flightNumber
        );
        
        console.log(`ud83dudcdd [getDualSoloFromIndividualLMP] Searching for flightNumber: ${flightNumber}, found item:`, !!syllabusItem);
        if (syllabusItem) {
            console.log(`ud83dudcdd [getDualSoloFromIndividualLMP] Found syllabus item:`, {
                id: syllabusItem.id,
                code: syllabusItem.code,
                sortieType: syllabusItem.sortieType
            });
        }

        if (syllabusItem && syllabusItem.sortieType) {
            console.log(`ud83cudfaf [Dual/Solo] Found ${syllabusItem.sortieType} for ${traineeName} - ${flightNumber}`);
            return syllabusItem.sortieType;
        }

        console.log(`ud83dudcdd [getDualSoloFromIndividualLMP] Returning 'Dual' - no sortieType found for ${flightNumber}`);
        return 'Dual'; // Default to Dual if not specified
    };

    // Apply Solo logic (trainee as PIC, clear crew) when flightType changes to Solo
    const applySoloLogic = () => {
        // Check the first crew member's flightType
        if (crew[0]?.flightType === 'Solo') {
            // For Solo events, set trainee as PIC
            const traineeName = crew[0]?.student || crew[0]?.pilot;
            if (traineeName) {
                // Update the first crew member: set trainee as pilot and clear instructor
                setCrew(prevCrew => {
                    const newCrew = [...prevCrew];
                    if (newCrew.length > 0) {
                        newCrew[0] = { 
                            ...newCrew[0], 
                            pilot: traineeName, 
                            instructor: '' // Clear instructor for solo flights
                        };
                    }
                    return newCrew;
                });
                console.log(`‚úàÔ∏è [Solo Logic] Applied: ${traineeName} as PIC, flightType set to Solo`);
            }
        }
    };

    const [locationType, setLocationType] = useState(event.locationType || 'Local');
    const [origin, setOrigin] = useState(event.origin || school);
    const [destination, setDestination] = useState(event.destination || school);
    const [formationType, setFormationType] = useState(event.formationType || '');
    const [isDeploy, setIsDeploy] = useState(event.isDeploy || false);
    
--
                    ))}
                </select>
            </div>
        );
    };    const formatDecimalHourToString = (decimalHour: number): string => {
        const hours = Math.floor(decimalHour);
        const minutes = Math.round((decimalHour % 1) * 60);
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    };

    // Auto-set Dual/Solo from Individual LMP when adding new events
    useEffect(() => {
        if (isAddingTile && flightNumber && crew[0]) {
            const traineeName = crew[0]?.student || crew[0]?.pilot;
            if (traineeName && traineeLMPs) {
                const individualLMPFlightType = getDualSoloFromIndividualLMP(flightNumber, traineeName);
                // Only update if the flightType is different to avoid infinite loop
                if (crew[0].flightType !== individualLMPFlightType) {
                    setCrew(prevCrew => {
                        const newCrew = [...prevCrew];
                        if (newCrew.length > 0) {
                            newCrew[0] = { ...newCrew[0], flightType: individualLMPFlightType };
                        }
                        return newCrew;
                    });
                    console.log(`üéØ [Auto Dual/Solo] Set to ${individualLMPFlightType} from Individual LMP for ${traineeName}`);
                }
            }
        }
    }, [isAddingTile, flightNumber, traineeLMPs]);

    // Auto-set Dual/Solo from Individual LMP when creating new events (not just tiles)
    useEffect(() => {
        if (crew[0]?.flightType === 'Solo') {
            const traineeName = crew[0]?.student || crew[0]?.pilot;
            // Only apply if pilot is not already set correctly
            if (traineeName && crew[0].pilot !== traineeName) {
                applySoloLogic();
            }
        }
    }, [crew[0]?.flightType, crew[0]?.student, crew[0]?.pilot]);

    // Effect to set default values based on event category
    useEffect(() => {
        if (eventCategory === 'sct') {
            // SCT defaults to Solo
            setCrew(prev => prev.map(c => ({ ...c, flightType: 'Solo' })));
            // Set default duration to 1.2
            if (!duration) setDuration(1.2);
        } else if (eventCategory === 'lmp_event' || eventCategory === 'lmp_currency') {
            // Set default duration to 1.2 for LMP events
            if (!duration) setDuration(1.2);
        } else if (eventCategory === 'staff_cat') {
            // Set default duration to 1.2 for Staff CAT
            if (!duration) setDuration(1.2);
        } else if (eventCategory === 'twr_di') {
            // TWR DI defaults to Solo
            setCrew(prev => prev.map(c => ({ ...c, flightType: 'Solo' })));
            // Set default duration to 1.2 for TWR DI
            if (!duration) setDuration(1.2);
            // Set default start time to 0800 only for new events
            if (isAddingTile || !event.startTime || event.startTime === 0) {
                setStartTime('08:00');
            }
        }
    }, [eventCategory]);

    // Effect to pull Type (Dual/Solo) from syllabus when flight number changes
    useEffect(() => {
        if (flightNumber && (eventCategory === 'lmp_event' || eventCategory === 'lmp_currency' || eventCategory === 'staff_cat' || eventCategory === 'twr_di')) {
            const syllabusItem = syllabusDetails.find(item => item.id === flightNumber);
            if (syllabusItem && syllabusItem.flightType) {
                setCrew(prev => prev.map(c => ({ ...c, flightType: syllabusItem.flightType as 'Dual' | 'Solo' })));
            }
        }
    }, [flightNumber, eventCategory, syllabusDetails]);

    // Effect to set Dual/Solo from Individual LMP when flight number changes (before pilot selection)
    useEffect(() => {
        if (isAddingTile || (isEditingDefault && (!event.id || event.id.startsWith('2d1b6a22')))) {
            // This is a new event or tile (check for generated IDs that start with our prefix)
            console.log(`\ud83d\udcdd [Flight Number Change] isAddingTile: ${isAddingTile}, isEditingDefault: ${isEditingDefault}, event.id: ${event.id}, flightNumber: ${flightNumber}`);
            
            if (flightNumber && crew[0] && traineeLMPs) {
                const traineeName = crew[0]?.student || crew[0]?.pilot;
                
                if (traineeName) {
                    // If pilot is selected, use their Individual LMP
                    console.log(`\ud83d\udcdd [Flight Number Change] Using selected trainee: ${traineeName}`);
                    const individualLMPFlightType = getDualSoloFromIndividualLMP(flightNumber, traineeName);
                    
                    if (crew[0].flightType !== individualLMPFlightType) {
                        setCrew(prevCrew => {
                            const newCrew = [...prevCrew];
                            if (newCrew.length > 0) {
                                newCrew[0] = { ...newCrew[0], flightType: individualLMPFlightType };
                            }
                            return newCrew;
                        });
                        console.log(`\ud83c\udfaf [Auto Dual/Solo] Set to ${individualLMPFlightType} from Individual LMP for selected trainee ${traineeName}`);
                    }
                } else {
                    // No pilot selected yet - find first trainee with this LMP and use their Individual LMP as default
                    console.log(`\ud83d\udcdd [Flight Number Change] No pilot selected - searching for default from any trainee with LMP ${flightNumber}`);
                    
                    let defaultFlightType: 'Dual' | 'Solo' = 'Dual'; // Default to Dual if nothing found
                    let foundTrainee = '';
                    
                    // Search through all trainees to find someone who has this LMP in their Individual LMP
                    for (const [traineeName, individualLMP] of traineeLMPs.entries()) {
                        const syllabusItem = individualLMP.find(item => 
                            item.id === flightNumber || item.code === flightNumber
                        );
                        
                        if (syllabusItem && syllabusItem.sortieType) {
                            defaultFlightType = syllabusItem.sortieType;
--
                    }
                    
                    if (crew[0].flightType !== defaultFlightType) {
                        setCrew(prevCrew => {
                            const newCrew = [...prevCrew];
                            if (newCrew.length > 0) {
                                newCrew[0] = { ...newCrew[0], flightType: defaultFlightType };
                            }
                            return newCrew;
                        });
                        console.log(`\ud83c\udfaf [Auto Dual/Solo] Set to ${defaultFlightType} as default from ${foundTrainee || 'system'} for LMP ${flightNumber}`);
                    }
                }
            }
        }
    }, [flightNumber, traineeLMPs, isAddingTile, isEditingDefault, event.id]);

    // Effect to update Dual/Solo from Individual LMP when trainee changes (after initial flight number selection)
    useEffect(() => {
        if (isAddingTile || (isEditingDefault && (!event.id || event.id.startsWith('2d1b6a22')))) {
            if (flightNumber && crew[0] && traineeLMPs) {
                const traineeName = crew[0]?.student || crew[0]?.pilot;
                
                if (traineeName) {
                    // Update when specific trainee is selected (may override the default)
                    const individualLMPFlightType = getDualSoloFromIndividualLMP(flightNumber, traineeName);
                    
                    if (crew[0].flightType !== individualLMPFlightType) {
                        setCrew(prevCrew => {
                            const newCrew = [...prevCrew];
                            if (newCrew.length > 0) {
                                newCrew[0] = { ...newCrew[0], flightType: individualLMPFlightType };
                            }
                            return newCrew;
                        });
                        console.log(`\ud83c\udfaf [Trainee Change] Updated to ${individualLMPFlightType} from Individual LMP for selected trainee ${traineeName}`);
--
            setOrigin(school);
            setDestination(school);
        }
    }, [locationType, school]);

    useEffect(() => {
        const isFormation = flightNumber === 'SCT FORM';
        const newSize = isFormation ? aircraftCount : 1;
        if (crew.length !== newSize) {
             const newCrew = Array.from({ length: newSize }, (_, i) => {
                // For SCT FORM with SCT category, default to Solo
                const defaultFlightType = (isFormation && eventCategory === 'sct') ? 'Solo' : 'Dual';
                return crew[i] || { flightType: defaultFlightType as 'Dual' | 'Solo', instructor: '', student: '', pilot: '', group: '', groupTraineeIds: [] };
            });
            setCrew(newCrew);
        }
    }, [aircraftCount, flightNumber, crew, eventCategory]);

    useEffect(() => {
      setEventType(getEventTypeFromSyllabus(flightNumber, syllabusDetails));
    }, [flightNumber, syllabusDetails]);

    // Helper function to get current deployments
--
        return () => document.removeEventListener("mousedown", handleClickOutside as any);
    }, []);
    
    const personnel = useMemo(() => [...instructors, ...trainees].sort(), [instructors, trainees]);
    
    const handleCrewChange = (index: number, field: keyof CrewMember, value: any) => {
        const newCrew = [...crew];
        const memberToUpdate = { ...newCrew[index] };

        if (field === 'flightType') {
            const flightTypeValue = value as 'Dual' | 'Solo';
            memberToUpdate.flightType = flightTypeValue;

            if (flightTypeValue === 'Solo') {
                memberToUpdate.instructor = '';
                memberToUpdate.student = '';
                memberToUpdate.group = '';
                memberToUpdate.groupTraineeIds = [];
            } else {
                memberToUpdate.pilot = '';
            }
        } else {
            // @ts-ignore - dynamic assignment
            memberToUpdate[field] = value;
--

        console.log('Flight number changed to:', newFlightNumber);
        if (newFlightNumber === 'SCT FORM' && !formationType) {
            setFormationType(formationTypes[0]);
        }
        
           
           if (newFlightNumber === 'SCT FORM' && eventCategory === 'sct') {
               // Set defaults for SCT FORM
               setAircraftCount(2);
               // Update crew to Solo
               setCrew(crew.map(member => ({
                   ...member,
                   flightType: 'Solo'
               })));
           } else if (newFlightNumber !== 'SCT FORM') {
               setAircraftCount(1);
           }
    };
    const handleAircraftCountChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const newCount = parseInt(e.target.value);
        setAircraftCount(newCount);
        // When changing aircraft count for SCT FORM, ensure all existing crew are Solo
        if (flightNumber === 'SCT FORM' && eventCategory === 'sct') {
            setTimeout(() => {
                setCrew(prevCrew => prevCrew.map(member => ({
                    ...member,
                    flightType: 'Solo' as 'Dual' | 'Solo'
                })));
            }, 100);
        }
    };

    // Helper function to convert time string (HH:MM) to decimal hours
    const parseTimeStringToHours = (timeString: string): number => {
        if (!timeString) return 0;
        
        // Handle both formats: "HH:MM" and "HHMM"
--
            for (let i = 0; i < deploymentAircraftCount; i++) {
                const deploymentTile: ScheduleEvent = {
                    id: `deployment-${event.id}-${i}-${Date.now()}`,
                    date: deploymentStartDate,
                    type: 'deployment',
                    startTime: deployStartHour,
                    duration: deployDuration,
                    resourceId: 'Deployed', // Will be reassigned by findAvailableResourceId
                    color: 'bg-gray-600/30', // Base color, styling handled in FlightTile
                    flightNumber: 'DEPLOYMENT',
                    flightType: 'Dual',
                    locationType: 'Land Away',
                    origin: 'DEPLOY',
                    destination: 'DEPLOY',
                    instructor: '',
                    student: '',
                    pilot: '',
                    isDeploy: true,
                    deploymentStartDate: deploymentStartDate,
                    deploymentStartTime: deploymentStartTime,
                    deploymentEndDate: deploymentEndDate,
--
            for (let m = 0; m < 60; m += 5) {
                const totalHours = h + m / 60;
                const label = `${String(h).padStart(2, '0')}${String(m).padStart(2, '0')}`; // 24-hour format without colon
                options.push({ label, value: totalHours });
            }
        }
        return options;
    }, []);

    const traineeObject = useMemo(() => {
        const traineeFullName = event.flightType === 'Dual' ? event.student : event.pilot;
        if (!traineeFullName) return null;
        return traineesData.find(t => t.fullName === traineeFullName) || null;
    }, [event.flightType, event.student, event.pilot, traineesData]);

    const handleSyllabusFocus = () => {
        if (isOracleContext && !crew[0]?.student && !crew[0]?.instructor) {
            setSyllabusSelectionError(true);
            setTimeout(() => setSyllabusSelectionError(false), 2000);
        }
    };
--
    const formationCallsign = isSctForm && formationType
        ? `${formationType}${index + 1}` 
        : `Aircraft ${index + 1}`;
    
    // Determine if we should use staff-only instructors
    const useStaffOnly = eventCategory === 'lmp_currency' || eventCategory === 'sct' || eventCategory === 'staff_cat' || eventCategory === 'twr_di';
    
    // Determine if we should show Trainee/Group fields (only for LMP Event and LMP Currency)
    const showTraineeFields = eventCategory === 'lmp_event' || eventCategory === 'lmp_currency';
    
    // Determine if we should show Crew field (only for SCT and Staff CAT when Dual)
    const showCrewField = (eventCategory === 'sct' || eventCategory === 'staff_cat' || eventCategory === 'twr_di') && crewMember.flightType === 'Dual';
    
    return (
        <div key={index} className={`space-y-4 ${crew.length > 1 ? 'p-3 bg-gray-700/50 rounded-lg' : ''}`}>
            {crew.length > 1 && <h4 className="text-sm font-bold text-sky-400">{formationCallsign}</h4>}

            <div>
                <label className="block text-sm font-medium text-gray-400">Dual/Solo</label>
                <select value={crewMember.flightType} onChange={e => handleCrewChange(index, 'flightType', e.target.value)} disabled={isDeploy} className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm disabled:bg-gray-700/50 disabled:cursor-not-allowed">
                    <option value="Dual">Dual</option>
                    <option value="Solo">Solo</option>
                </select>
            </div>

            {crewMember.flightType === 'Dual' ? (
                <>
                    {/* Instructor/Pilot Field - Staff only for certain categories */}
                    {useStaffOnly ? (
                        renderStaffInstructorDropdown(
                            // For SCT, use pilot field; for others, use instructor field
                            eventCategory === 'sct' ? crewMember.pilot : crewMember.instructor,
                            (value) => handleCrewChange(index, eventCategory === 'sct' ? 'pilot' : 'instructor', value),
                            (eventCategory === 'sct' || eventCategory === 'staff_cat' || eventCategory === 'twr_di') ? 'Pilot' : 'Instructor',
                            isDeploy
                        )
--
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </>
                    )}
                    
                    {/* Crew Field - Only for SCT and Staff CAT when Dual */}
                    {showCrewField && (
                        renderStaffInstructorDropdown(
                            crewMember.student,
                            (value) => handleCrewChange(index, 'student', value),
                            'Crew',
                            isDeploy,
                            eventCategory === 'sct' // Include PAX option for SCT events
                        )
                    )}
                </>
               ) : (
                   // Solo - Use staff dropdown for SCT and Staff CAT
                   useStaffOnly ? (
                       <div>
                           <label className="block text-sm font-medium text-gray-400">Pilot</label>
                           <select 
                               value={crewMember.pilot} 
                               onChange={e => handleCrewChange(index, 'pilot', e.target.value)} 
                               disabled={isDeploy}
                               className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm disabled:bg-gray-700/50 disabled:cursor-not-allowed appearance-none cursor-pointer z-10"
                           >
                               <option value="" disabled>Select pilot</option>
--
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="text-gray-300 space-y-2">
                                    <p><strong>Syllabus Item:</strong> {event.flightNumber}</p>
                                    {event.type === 'flight' && <p><strong>Route:</strong> {event.origin}-{event.destination}</p>}
                                    {event.type === 'flight' && event.area && <p><strong>Area:</strong> {event.area}</p>}
                                    <p><strong>Dual/Solo:</strong> <span className="font-semibold">{event.flightType}</span></p>
                                    {event.flightType === 'Dual' ? (
                                        <>
                                            {event.eventCategory === 'sct' ? (
                                                <p><strong>Instructor:</strong> {event.instructor || event.pilot}</p>
                                            ) : (
                                                <p><strong>Instructor:</strong> {event.instructor}</p>
                                            )}
                                            {(event.type === 'ground' && event.attendees && event.attendees.length > 0) ? (
                                                <div>
                                                    <p><strong>Attendees ({event.attendees.length}):</strong></p>
                                                    <div className="mt-1 bg-gray-700/50 p-2 rounded-md max-h-32 overflow-y-auto">
