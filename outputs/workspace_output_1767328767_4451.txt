import React, { useState } from 'react';
import { CancellationCode, CancellationCodeCategory, CancellationCodeAppliesTo } from '../types';

interface CancellationCodesTableProps {
  codes: CancellationCode[];
  onAddCode: (code: CancellationCode) => void;
  onEditCode: (oldCode: string, newCode: CancellationCode) => void;
  onToggleActive: (code: string) => void;
  canEdit: boolean; // Based on user role
  usedCodes: Set<string>; // Codes that have been used in cancellations
}

const CancellationCodesTable: React.FC<CancellationCodesTableProps> = ({
  codes,
  onAddCode,
  onEditCode,
  onToggleActive,
  canEdit,
  usedCodes,
}) => {
  const [isAddingNew, setIsAddingNew] = useState(false);
  const [editingCode, setEditingCode] = useState<string | null>(null);
  const [formData, setFormData] = useState<Partial<CancellationCode>>({
    code: '',
    category: 'Aircraft',
    description: '',
    appliesTo: 'Both',
    isActive: true,
  });

  const handleStartAdd = () => {
    setFormData({
      code: '',
      category: 'Aircraft',
      description: '',
      appliesTo: 'Both',
      isActive: true,
    });
    setIsAddingNew(true);
    setEditingCode(null);
  };

  const handleStartEdit = (code: CancellationCode) => {
    setFormData(code);
    setEditingCode(code.code);
    setIsAddingNew(false);
  };

  const handleCancel = () => {
    setIsAddingNew(false);
    setEditingCode(null);
    setFormData({
      code: '',
      category: 'Aircraft',
      description: '',
      appliesTo: 'Both',
      isActive: true,
    });
  };

  const handleSave = () => {
    if (!formData.code || !formData.description) {
      return;
    }

    const newCode: CancellationCode = {
      code: formData.code.toUpperCase(),
      category: formData.category as CancellationCodeCategory,
      description: formData.description,
      appliesTo: formData.appliesTo as CancellationCodeAppliesTo,
      isActive: formData.isActive ?? true,
      createdAt: formData.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };

    if (isAddingNew) {
      onAddCode(newCode);
    } else if (editingCode) {
      onEditCode(editingCode, newCode);
    }

    handleCancel();
  };

  const sortedCodes = [...codes].sort((a, b) => {
    // Sort by category first, then by code
    if (a.category !== b.category) {
      return a.category.localeCompare(b.category);
    }
    return a.code.localeCompare(b.code);
  });

  return (
    <div className="bg-gray-800 rounded-lg border border-gray-700 p-6">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold text-white">Cancellation Codes (Master Table)</h2>
        {canEdit && (
          <button
            onClick={handleStartAdd}
            disabled={isAddingNew || editingCode !== null}
