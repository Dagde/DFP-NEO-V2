                    style={{
                        fontSize: `${scaledFontSize}px`,
                        lineHeight: '1',
                        opacity: 0.7,
                    }}
                >
                    {event.area}
                </div>
            )}
            {callsign && (
                <div
                    className="absolute bottom-0.5 right-3 font-mono text-white/80"
                    style={{
                        fontSize: `${scaledFontSize - 2}px`,
                        lineHeight: '1',
                        opacity: 0.8,
                    }}
                >
                    {callsign}
                </div>
            )}
        </>
    );
  };

  const shadowClass = isDragging ? 'shadow-xl' : 'shadow-md';
  const commonClasses = `absolute rounded-sm ${isDraggable ? 'cursor-grab' : 'cursor-pointer'} transition-all duration-200 ${isDragging ? 'opacity-80 z-50' : 'z-10'} ${shadowClass}`;
  
  // Check if this is a STBY event
  const isStbyEvent = event.resourceId && (event.resourceId.startsWith('STBY') || event.resourceId.startsWith('BNF-STBY'));
  
  // Handle deployment tile special styling
  const backgroundClass = event.type === 'deployment' 
    ? 'bg-gray-600/30 border border-white/60' 
    : event.type === 'unavailability'
    ? 'bg-red-900/80 border border-red-600/60'
    : isUnavailabilityConflict ? 'bg-red-800/90' : isConflicting ? 'bg-red-600/70' : event.color;
  const ringClass = getDynamicRingClass();
  const dutySupBorderClass = isDutySup ? 'border border-black' : '';
  const multiSelectRingClass = isSelected ? 'ring-2 ring-cyan-400 ring-offset-2 ring-offset-gray-900' : '';
  
  const finalClasses = [commonClasses];

  if (isPreview) {
      finalClasses.push(event.color); // The color is set in App.tsx for oracle preview
      finalClasses.push('border-2 border-dashed border-sky-300');
  } else {
      finalClasses.push(backgroundClass);
      finalClasses.push(`ring-[0.92px] ${ringClass}`);
      finalClasses.push(dutySupBorderClass);
      finalClasses.push(multiSelectRingClass);
  }
  // Ensure we don't clip the flyout which sits outside
  // We can't use overflow-hidden on the tile itself if we want the flyout to potentially pop out,
  // but usually we want to clip inner content.
  // Strategy: Render flyout as a sibling or use absolute positioning that isn't clipped.
  // Actually, standard `absolute` children are clipped if parent has `overflow: hidden`.
  // If we remove `overflow-hidden`, we must ensure inner content doesn't spill.
  // For safety, we will NOT use `overflow-hidden` on the main tile div if it's small, to allow the flyout to be visible if we nest it.
  // Better approach: Since we control inner content rendering, we can just omit overflow-hidden.
  if (!isSmallTile) {
      finalClasses.push('overflow-hidden');
  }

  // Flyout content
  const renderFlyout = () => {
      if (!isSmallTile) return null;
      
      const flyoutStyle: React.CSSProperties = {
          position: 'absolute',
          top: 0,
          [flyoutToLeft ? 'right' : 'left']: '100%',
          marginLeft: flyoutToLeft ? 0 : '4px',
          marginRight: flyoutToLeft ? '4px' : 0,
          whiteSpace: 'nowrap',
          zIndex: 60,
      };

      return (
          <div style={flyoutStyle} className="flex items-center">
                {/* Connector Line/Arrow could go here */}
               <div className="bg-gray-800 border border-gray-600 rounded px-2 py-1 shadow-lg flex items-center space-x-3 text-xs">
                    <div>
                        <div className={`font-bold ${picClasses.replace('truncate', '')}`}>{picName?.split(' â€“ ')[0]}{picSeatConfig && <span style={{fontWeight: "normal", color: "rgba(255, 255, 255, 0.8)"}}>{picSeatConfig}</span>}</div>
                        <div className={studentClasses.replace('truncate', '')}>{typeof studentDisplay === 'string' ? <>{studentDisplay}{studentSeatConfig && <span style={{fontWeight: "normal", color: "rgba(255, 255, 255, 0.8)"}}>{studentSeatConfig}</span>}</> : studentDisplay}</div>
                    </div>
                    <div className="h-6 w-px bg-gray-600"></div>
                    <div>
                        <div className="font-mono font-semibold text-sky-400">{event.flightNumber}</div>
                        <div className="font-mono text-gray-400">{formatTime(effectiveStartTime)}</div>
                    </div>
                    {callsign && <div className="font-mono text-gray-500 text-[10px]">{callsign}</div>}
               </div>
          </div>
      );
  }

  return (
    <div
      data-is-flight-tile="true"
      style={style}
      className={finalClasses.join(' ')}
      onClick={onSelectEvent}
      onMouseDown={(e) => {
          e.stopPropagation(); // Prevent grid's handleMouseDown from being called
          onMouseDown(e);
      }}
      onMouseEnter={onMouseEnter}
      onMouseLeave={onMouseLeave}
      
    >
        {isChanged && !isPreview && (
            <div className="absolute right-0 top-0 bottom-0 w-1.5 changed-bar-stripes z-20 pointer-events-none" />
        )}
        {isStbyEvent && !isPreview && (
            <div 
                className="absolute inset-0 pointer-events-none z-10"
                style={{
                    backgroundImage: 'repeating-linear-gradient(45deg, rgba(209, 213, 219, 0.4) 0px, rgba(209, 213, 219, 0.4) 3px, transparent 3px, transparent 8px)',
                }}
            />
        )}
        <div className="relative w-full h-full text-white">
            {isDutySup ? (
                <>
                    <div 
                        className="absolute top-1 left-1 font-mono text-white/60 pointer-events-none"
                        style={{ fontSize: `${scaledFontSize * 0.825}px` }}
                    >
                        {formatTime(effectiveStartTime)}
                    </div>
                    <div 
                        className="absolute top-1 right-1 font-mono text-white/60 pointer-events-none"
                        style={{ fontSize: `${scaledFontSize * 0.825}px` }}
                    >
                        {formatTime(effectiveStartTime + effectiveDuration)}
                    </div>
                </>
            ) : (
                !isSmallTile && (
                    <div 
                        className="absolute -top-px left-1 font-mono text-white/60 pointer-events-none"
                        style={{ fontSize: `${scaledFontSize * 0.75}px` }}
                    >
                        {formatTime(effectiveStartTime)}
                    </div>
                )
            )}
            {renderContent()}
            {renderFlyout()}
        </div>
    </div>
  );
};

export default FlightTile;
