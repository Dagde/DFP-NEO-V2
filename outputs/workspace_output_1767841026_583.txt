import { Instructor, Trainee, Aircraft, ScheduleEvent } from '../types';

// API Base URL
const API_BASE = '/api';

// API Response Types
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
}

interface PersonnelResponse {
  id: string;
  userId: string;
  role: string;
  firstName: string;
  lastName: string;
  rank?: string;
  callsignNumber?: number;
  callsignPrefix?: string;
  unit?: string;
  qualificationStatus?: string;
  isAvailable?: boolean;
  createdAt: string;
  updatedAt: string;
}

interface AircraftResponse {
  id: string;
  aircraftNumber: string;
  type: string;
  status: string;
  createdAt: string;
  updatedAt: string;
}

// Helper function to convert API personnel to Instructor/Trainee format
const convertPersonnelToInstructor = (p: PersonnelResponse): Instructor => ({
  id: p.id,
  name: `${p.rank} ${p.lastName}`,
  rank: p.rank || '',
  unit: p.unit || '',
  callsign: p.callsignNumber && p.callsignPrefix 
    ? `${p.callsignPrefix} ${String(p.callsignNumber).padStart(3, '0')}`
    : '',
  isAvailable: p.isAvailable ?? true,
});

const convertPersonnelToTrainee = (p: PersonnelResponse): Trainee => ({
  id: p.id,
  fullName: `${p.rank} ${p.lastName}`,
  rank: p.rank as TraineeRank,
  unit: p.unit || '',
  traineeCallsign: p.callsignNumber && p.callsignPrefix
    ? `${p.callsignPrefix} ${String(p.callsignNumber).padStart(3, '0')}`
    : '',
  isAvailable: p.isAvailable ?? true,
});

const convertAircraft = (a: AircraftResponse): Aircraft => ({
  id: a.id,
  aircraftNumber: a.aircraftNumber,
  type: a.type,
  status: a.status,
});

// Fetch wrapper with error handling
async function fetchAPI<T>(
  endpoint: string,
  options?: RequestInit
): Promise<ApiResponse<T>> {
  try {
    const response = await fetch(`${API_BASE}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options?.headers,
      },
    });

    if (!response.ok) {
      throw new Error(`API Error: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();
    return { success: true, data };
  } catch (error) {
    console.error(`API fetch error for ${endpoint}:`, error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

// Personnel API
export async function fetchInstructors(): Promise<Instructor[]> {
  const result = await fetchAPI<PersonnelResponse[]>('/personnel?role=INSTRUCTOR');
  if (result.success && result.data) {
