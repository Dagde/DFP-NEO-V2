import React, { useState, useEffect } from 'react';
import CancellationCodesTable from './CancellationCodesTable';
import ACHistoryAnalytics from './ACHistoryAnalytics';
import RecentCancellationsTable from './RecentCancellationsTable';
import { CancellationCode, CancellationRecord } from '../types';
import { initialCancellationCodes } from '../data/cancellationCodes';

interface ACHistoryPageProps {
  currentUserRole: string;
  cancellationRecords: CancellationRecord[];
}

const ACHistoryPage: React.FC<ACHistoryPageProps> = ({
  currentUserRole,
  cancellationRecords,
}) => {
  const [cancellationCodes, setCancellationCodes] = useState<CancellationCode[]>([]);
  const [usedCodes, setUsedCodes] = useState<Set<string>>(new Set());

  // Check if user has edit permissions (Admin or Super Admin)
  const canEdit = currentUserRole === 'Super Admin' || currentUserRole === 'Admin';

  // Load cancellation codes from localStorage or use initial data
  useEffect(() => {
    const storedCodes = localStorage.getItem('cancellationCodes');
    if (storedCodes) {
      try {
        setCancellationCodes(JSON.parse(storedCodes));
      } catch (error) {
        console.error('Error loading cancellation codes:', error);
        setCancellationCodes(initialCancellationCodes);
      }
    } else {
      setCancellationCodes(initialCancellationCodes);
      localStorage.setItem('cancellationCodes', JSON.stringify(initialCancellationCodes));
    }
  }, []);

  // Calculate which codes have been used in cancellations
  useEffect(() => {
    const used = new Set<string>();
    cancellationRecords.forEach(record => {
      used.add(record.cancellationCode);
      if (record.manualCodeEntry) {
        used.add(record.manualCodeEntry);
      }
    });
    setUsedCodes(used);
  }, [cancellationRecords]);

