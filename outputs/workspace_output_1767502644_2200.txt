
import React, { MouseEvent } from 'react';
import { ScheduleEvent, Trainee, EventSegment } from '../types';

interface FlightTileProps {
  event: ScheduleEvent | EventSegment;
  traineesData: Trainee[];
  onSelectEvent: () => void;
  onMouseDown: (e: MouseEvent<HTMLDivElement>) => void;
  onMouseEnter: () => void;
  onMouseLeave: () => void;
  pixelsPerHour: number;
  rowHeight: number;
  startHour: number;
  row: number;
  isDragging: boolean;
  isConflicting?: boolean;
  conflictedPersonnelName?: string | null;
  personnelData: Map<string, { callsignPrefix: string; callsignNumber: number }>;
  seatConfigs: Map<string, string>;
  isDraggable?: boolean;
  currentTime: Date;
  isUnavailabilityConflict?: boolean;
  unavailablePersonnel?: string[];
  isSelected?: boolean;
  isChanged?: boolean;
  isPreview?: boolean;
}

const formatTime = (time: number): string => {
    const hours = Math.floor(time);
    const minutes = Math.round((time % 1) * 60);
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
};

const getAuthorizationTextColorClass = (event: ScheduleEvent, currentTime: Date): string => {
    if (event.type !== 'flight') {
        return '';
    }
    
    const todayStr = new Date().toISOString().split('T')[0];
    
    // Only apply highlighting for the current date
    if (event.date !== todayStr) {
        return ''; // No auth-related text color for past/future dates
    }
    
    // From here, it's today's date.
    const isFullySigned = !!(event.authoSignedBy && event.captainSignedBy);
    const isAuthoSigned = !!(event.authoSignedBy || event.isVerbalAuth);
    const isUnsigned = !isAuthoSigned && !event.captainSignedBy;

    if (isFullySigned) {
        return 'text-green-400';
    }

    const nowInHours = currentTime.getHours() + currentTime.getMinutes() / 60;
    const endTime = event.startTime + event.duration;
    if (nowInHours >= endTime) {
        return ''; // Default text color for lapsed events on today's schedule
    }

    if (isAuthoSigned && !event.captainSignedBy) {
        return 'text-sky-400';
    }

    if (isUnsigned) {
        const timeUntilStart = event.startTime - nowInHours;
        
        if (timeUntilStart <= 0.25) {
            return 'text-red-500';
        }

        if (timeUntilStart <= 2) {
            return 'text-amber-400';
        }
    }

    return '';
};


const FlightTile: React.FC<FlightTileProps> = ({ event, traineesData, onSelectEvent, onMouseDown, onMouseEnter, onMouseLeave, pixelsPerHour, rowHeight, startHour, row, isDragging, isConflicting, conflictedPersonnelName, personnelData, seatConfigs, isDraggable = true, currentTime, isUnavailabilityConflict, unavailablePersonnel, isSelected = false, isChanged = false, isPreview = false }) => {
  // ERROR TRACKING: Log props to identify missing seatConfigs

  // Removed unit color logic - colors are now handled in PersonnelColumn only
  console.log('üîç FLIGHT TILE ERROR TRACKING - Props received:');
  console.log('  - event.id:', event?.id);
  console.log('  - event.type:', event?.type);
  console.log('  - personnelData size:', personnelData?.size);
  console.log('  - seatConfigs type:', typeof seatConfigs);
  console.log('  - seatConfigs value:', seatConfigs);
  console.log('  - seatConfigs === undefined:', seatConfigs === undefined);
  console.log('  - seatConfigs === null:', seatConfigs === null);
  
  try {
    // Test access to seatConfigs to trigger the error
    const testAccess = seatConfigs;
    console.log('‚úÖ seatConfigs access successful');
  } catch (error) {
