  // Default to right for normal small tiles unless they are near the right edge (heuristic)
  const isEndSegment = segment.segmentType === 'start'; 
  const flyoutToLeft = isEndSegment || (effectiveStartTime + effectiveDuration > 22); // Logic: if it ends late in the day, flyout left

  const style: React.CSSProperties = {
    left: `${(effectiveStartTime - startHour) * pixelsPerHour}px`,
    top: `${row * rowHeight}px`,
    width: `${tileWidth}px`,
    height: `${rowHeight - 4}px`, // a little padding
    marginTop: '2px',
  };
  
  const getDynamicRingClass = () => {
    if (isConflicting || isUnavailabilityConflict) {
        return 'ring-red-400'; // Highest priority
    }
    
    const todayStr = new Date().toISOString().split('T')[0];

    // Only apply auth highlighting for the current date
    if (event.date !== todayStr) {
        return 'ring-transparent';
    }

    // From here, it's today's date.
    const isFullySigned = !!(event.authoSignedBy && event.captainSignedBy);
    if (isFullySigned) {
        return 'ring-green-400';
    }
    
    const nowInHours = currentTime.getHours() + currentTime.getMinutes() / 60;
    const endTime = event.startTime + event.duration;

    // Lapsed status for today - no border required on main schedule
    if (nowInHours >= endTime) {
        return 'ring-transparent';
    }
    
    const isAuthoSigned = !!(event.authoSignedBy || event.isVerbalAuth);
    // Awaiting PIC - no border required on main schedule
    if (isAuthoSigned) {
        return 'ring-transparent';
    }

    // Time-based warnings for upcoming unsigned events
    const timeUntilStart = event.startTime - nowInHours;
    if (timeUntilStart <= 0.25) {
        return 'ring-red-500'; // Needs auth urgently
    }
    if (timeUntilStart <= 2) {
        return 'ring-amber-400'; // Needs auth soon
    }

    return 'ring-transparent'; // Default for unsigned flights > 2hrs away on the current day
  };

  const baseFontSize = 8;
  const optimalWidth = 200; 
  const minFontSize = 7;
  const maxFontSize = 13;
  
  const scaledFontSize = Math.max(minFontSize, Math.min(maxFontSize, (tileWidth / optimalWidth) * baseFontSize));

  // For SCT events, pilot field contains PIC, student field contains crew (for Dual)
  const isSctEvent = event.eventCategory === 'sct';
  
  
  
  const picName = isSctEvent ? event.pilot : (event.flightType === 'Solo' ? event.pilot : event.instructor);
  const studentName = isSctEvent ? event.student : (event.student || (event.flightType === 'Solo' ? event.pilot : ''));
  
  let picClasses = `font-semibold truncate`;
  let studentClasses = `truncate`;

  if (isPreview) {
      if (picName?.includes('✓')) {
          picClasses = 'font-bold truncate text-green-400';
      } else if (picName?.includes('✕')) {
          picClasses = 'font-bold truncate text-red-500';
      }

      if (studentName?.includes('✓')) {
          studentClasses = 'font-bold truncate text-green-400';
      } else if (studentName?.includes('✕')) {
          studentClasses = 'font-bold truncate text-red-500';
      }
  } else {
      const textColorClass = getAuthorizationTextColorClass(event, currentTime);
      const picHasUnavailability = unavailablePersonnel && unavailablePersonnel.includes(picName || '');
      const studentHasUnavailability = unavailablePersonnel && unavailablePersonnel.includes(studentName || '');
      
      // Check for event finish to stop highlighting unavailability on past events
      const nowInHours = currentTime.getHours() + currentTime.getMinutes() / 60;
      const eventEndTime = event.startTime + event.duration;
      const isEventFinished = nowInHours >= eventEndTime && event.date === new Date().toISOString().split('T')[0];

      if ((conflictedPersonnelName === picName) || (picHasUnavailability && !isEventFinished)) {
          picClasses = 'font-bold truncate text-red-500';
      } else if (textColorClass) {
          picClasses += ` ${textColorClass}`;
      }

      if ((conflictedPersonnelName === studentName) || (studentHasUnavailability && !isEventFinished)) {
          studentClasses = 'font-bold truncate text-red-500';
      } else if (textColorClass) {
          studentClasses += ' text-white/80';
      } else {
          studentClasses += ' text-white/80';
      }
  }
  
  const getStudentDisplay = () => {
      if (isPreview) {
          return studentName;
      }

        // For SCT Solo events, show SOLO label
        if (isSctEvent && event.flightType === 'Solo') {
            return (
                   <span className="bg-yellow-500/20 text-yellow-100 px-1.5 py-0.5 rounded-sm font-bold" style={{fontSize: isSmallTile ? '10px' : `${scaledFontSize * 0.85}px`}}>
                       SOLO
                   </span>
               );
           }

      // For SCT Dual events, show crew name from student field
      if (isSctEvent && event.flightType === 'Dual' && event.student) {
          return event.student.split(' – ')[0];
      }

        if (event.flightType === 'Solo') {
            return (
                <span className="bg-yellow-500/20 text-yellow-100 px-1.5 py-0.5 rounded-sm font-bold" style={{fontSize: isSmallTile ? '10px' : `${scaledFontSize * 0.85}px`}}>
                    SOLO
                </span>
            );
        }
      if ((event.groupTraineeIds && event.groupTraineeIds.length > 1) || 
          (event.attendees && event.attendees.length > 1) || 
          event.student === 'Multiple') {
          return 'Group';
      }
      
      if (event.student && event.student !== 'Multiple') {
          return event.student.split(' – ')[0];
      }

      if (event.attendees && event.attendees.length === 1) {
          return event.attendees[0].split(' – ')[0];
      }
      
