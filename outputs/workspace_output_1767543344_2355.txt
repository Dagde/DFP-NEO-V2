import NextAuth, { DefaultSession, User as NextAuthUser } from 'next-auth';
import { PrismaAdapter } from '@auth/prisma-adapter';
import CredentialsProvider from 'next-auth/providers/credentials';
import { PrismaClient, UserStatus } from '@prisma/client';
import * as bcrypt from 'bcryptjs';
import { createAuditLog } from './audit';

const prisma = new PrismaClient();

// Extend the built-in session types
declare module 'next-auth' {
  interface Session {
    user: {
      id: string;
      userId: string;
      displayName: string | null;
      email: string | null;
      status: UserStatus;
      permissionsRole: {
        id: string;
        name: string;
      };
      mustChangePassword: boolean;
    } & DefaultSession['user'];
  }

  interface User {
    id: string;
    userId: string;
    displayName: string | null;
    email: string | null;
    status: UserStatus;
    permissionsRole: {
      id: string;
      name: string;
    };
    mustChangePassword: boolean;
  }
}

// Rate limiting store (in-memory for now, use Redis in production)
const loginAttempts = new Map<string, { count: number; lockedUntil?: number }>();

function checkRateLimit(identifier: string): { allowed: boolean; lockedUntil?: number } {
  const now = Date.now();
  const attempts = loginAttempts.get(identifier);

  if (attempts?.lockedUntil && attempts.lockedUntil > now) {
    return { allowed: false, lockedUntil: attempts.lockedUntil };
  }
