generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String                @id @default(cuid())
  username        String                @unique
  email           String?               @unique
  password        String
  role            Role                  @default(USER)
  firstName       String?
  lastName        String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  lastLogin       DateTime?
  isActive        Boolean               @default(true)
  createdById     String?
  userId          String                @unique
  aircraft        Aircraft[]            @relation("Aircraft")
  AuditLog        AuditLog[]
  cancellations   CancellationHistory[] @relation("CancellationHistory")
  flightSchedules FlightSchedule[]      @relation("FlightSchedules")
  personnel       Personnel[]           @relation("Personnel")
  trainees        Trainee[]              @relation("Trainee")
  schedules       Schedule[]
  sessions        Session[]
  createdBy       User?                 @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdUsers    User[]                @relation("UserCreatedBy")
  settings        UserSettings?

  @@index([email])
  @@index([username])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([action])
  @@index([entityType])
  @@index([userId])
}

model Schedule {
  id        String   @id @default(cuid())
  userId    String
  date      String
  data      Json
  version   String   @default("flight-school")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, version])
  @@index([userId])
  @@index([date])
}

model UserSettings {
  id        String   @id @default(cuid())
  userId    String   @unique
  settings  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DataBackup {
  id        String   @id @default(cuid())
  type      String
  data      Json
  createdAt DateTime @default(now())
  userId    String?

  @@index([type])
  @@index([createdAt])
}

model FlightSchedule {
  id           String   @id @default(cuid())
  userId       String
  date         DateTime
  scheduleData Json
  version      String   @default("1.0")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation("FlightSchedules", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

model Personnel {
  id                       String   @id @default(cuid())
  userId                   String   @unique
  
  // Basic Information
  idNumber                 Int?     // PMKeys/ID (same as userId) - Optional for migration
  name                     String
  rank                     String?  // WGCDR, SQNLDR, FLTLT, FLGOFF, PLTOFF, Mr
  service                  String?  // RAAF, RAN, or ARA
  role                     String?  // QFI, or SIM IP
  callsignNumber           Int?
  
  // Qualifications & Roles (Boolean flags)
  category                 String?  // A2, B1, B2, C1, C2, or INSTRUCTOR
  seatConfig               String?  // Normal, FWD/SHORT, REAR/SHORT, or FWD/LONG
  isTestingOfficer         Boolean  @default(false)
  isExecutive              Boolean  @default(false)
  isFlyingSupervisor       Boolean  @default(false)
  isIRE                    Boolean  @default(false)
  isCommandingOfficer      Boolean  @default(false)
  isCFI                    Boolean  @default(false)
  isDeputyFlightCommander  Boolean  @default(false)
  isContractor             Boolean  @default(false)
  isAdminStaff             Boolean  @default(false)
  isQFI                    Boolean  @default(false)
  isOFI                    Boolean  @default(false)
  
  // Assignment
  location                 String?
  unit                     String?
  flight                   String?
  
  // Contact
  phoneNumber              String?
  email                    String?
  
  // Permissions
  permissions              String[] // Trainee, Staff, Ops, Scheduler, Course Supervisor, Admin, Super Admin
  
  // Unavailability (replaces availability)
  unavailability           Json?    // Array of UnavailabilityPeriod objects
  
  // Logbook Experience
  priorExperience          Json?    // LogbookExperience object
  
  // Legacy fields (kept for migration)
  qualifications           Json?    // Will be migrated to individual fields
  availability             Json?    // Will be migrated to unavailability
  preferences              Json?    // Not currently used in UI
  
  // Metadata
  isActive                 Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  
  // Relations
  user           User     @relation("Personnel", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([idNumber])
  @@index([role])
  @@index([isActive])
}

model Trainee {
  id                       String   @id @default(cuid())
  userId                   String?  @unique  // Links to User table (optional - trainees may not have login)
  
  // Basic Information
  idNumber                 Int      @unique  // PMKeys/ID
  name                     String
  fullName                 String   // Name with course
  rank                     String?  // OFFCDT, PLTOFF, SQNLDR, WGCDR
  service                  String?  // RAAF, RAN, or ARA
  course                   String?  // BPC+IPC, FIC, OFI, WSO, etc.
  lmpType                  String?  @default("BPC+IPC")
  traineeCallsign          String?
  
  // Status
  seatConfig               String?  // Normal, FWD/SHORT, REAR/SHORT, or FWD/LONG
  isPaused                 Boolean  @default(false)
  
  // Unavailability
  unavailability           Json?    // Array of UnavailabilityPeriod objects
  
  // Assignment
  unit                     String?
  flight                   String?
  location                 String?
  
  // Contact
  phoneNumber              String?
  email                    String?
  
  // Instructors
  primaryInstructor        String?  // Instructor name
  secondaryInstructor      String?  // Instructor name
  
  // Progress Tracking
  lastEventDate            DateTime?
  lastFlightDate           DateTime?
  currencyStatus           Json?    // Array of PersonCurrencyStatus objects
  
  // Permissions
  permissions              String[]
  
  // Logbook Experience
  priorExperience          Json?    // LogbookExperience object
  
  // Metadata
  isActive                 Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  
  // Relations
  user                     User?    @relation("Trainee", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([idNumber])
  @@index([course])
  @@index([unit])
  @@index([isActive])
}

model Aircraft {
  id             String   @id @default(cuid())
  userId         String
  aircraftNumber String
  type           String
  status         String   @default("available")
  configuration  Json?
  maintenanceLog Json?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation("Aircraft", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, aircraftNumber])
  @@index([userId])
  @@index([status])
  @@index([isActive])
}

model CancellationHistory {
  id               String   @id @default(cuid())
  userId           String
  scheduleId       String?
  eventId          String
  eventType        String
  cancellationCode String
  reason           String?
  cancelledBy      String
  cancelledAt      DateTime @default(now())
  originalData     Json
  user             User     @relation("CancellationHistory", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduleId])
  @@index([cancelledAt])
  @@index([cancellationCode])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  PILOT
  INSTRUCTOR
  USER
}
