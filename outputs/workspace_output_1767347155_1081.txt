
import React, { useState, useEffect, useMemo, useRef } from 'react';
import { ScheduleEvent, SyllabusItemDetail, Trainee, Instructor, OracleTraineeAnalysis, SctRequest, FormationCallsign, CancellationCode } from '../types';
import { v4 as uuidv4 } from 'uuid';
import CancelEventFlyout from './CancelEventFlyout';
import MassBriefCompleteFlyout, { MassBriefConfirmationFlyout } from './MassBriefCompleteFlyout';
import { VisualAdjustModal } from './VisualAdjustModal';

interface EventDetailModalProps {
  event: ScheduleEvent;
  onClose: () => void;
  onSave: (events: ScheduleEvent[]) => void;
  onDeleteRequest: () => void;
  isEditingDefault?: boolean;
  instructors: string[];
  trainees: string[];
  syllabus: string[];
  syllabusDetails: SyllabusItemDetail[];
  highlightedField?: 'startTime' | 'instructor' | 'student' | null;
  onScoresCreated?: (scores: any[]) => void; // New callback for creating scores
  school: 'ESL' | 'PEA';
  traineesData: Trainee[];
  instructorsData: Instructor[];
  courseColors: { [key: string]: string };
  onNavigateToHateSheet: (trainee: Trainee) => void;
  onNavigateToSyllabus: (flightNumber: string) => void;
  onOpenPt051: (trainee: Trainee) => void;
  onOpenAuth: (event: ScheduleEvent) => void;
  onOpenPostFlight: (event: ScheduleEvent) => void;
  isConflict: boolean;
  onNeoClick: (event: ScheduleEvent) => void;
  traineeLMPs?: Map<string, SyllabusItemDetail[]>;
  oracleContextForModal?: {
      availableInstructors: string[];
      availableTraineesAnalysis: OracleTraineeAnalysis[];
  } | null;
  sctRequests?: SctRequest[];
  sctEvents?: string[];
     eventsForDate?: ScheduleEvent[];
  // New props for deployment functionality
  publishedSchedules?: Record<string, ScheduleEvent[]>;
  nextDayBuildEvents?: ScheduleEvent[];
  activeView?: string;
  isAddingTile?: boolean;
    formationCallsigns?: FormationCallsign[];
    currentLocation?: string;
    onVisualAdjustStart?: (event: ScheduleEvent) => void;
    onVisualAdjustEnd?: (event: ScheduleEvent) => void;
    onSavePT051Assessment?: (assessment: any) => void;
    cancellationCodes?: CancellationCode[];
    onCancelEvent?: (eventId: string, cancellationCode: string, manualCodeEntry?: string) => void;
}

interface CrewMember {
    flightType: 'Dual' | 'Solo';
    instructor: string;
    student: string;
    pilot: string;
    group: string;
    groupTraineeIds: number[]; // Added to track selected IDs
}

const getEventTypeFromSyllabus = (syllabusId: string, syllabusDetails: SyllabusItemDetail[]): 'flight' | 'ftd' | 'ground' => {
    const detail = syllabusDetails.find(d => d.id === syllabusId);
    if (!detail) { // Fallback for items not in syllabus like 'SCT FORM' or if data is missing
        if (syllabusId.includes('FTD')) return 'ftd';
        if (syllabusId.includes('CPT') || syllabusId.includes('MB') || syllabusId.includes('TUT') || syllabusId.includes('QUIZ')) return 'ground';
        return 'flight';
    }
    if (detail.type === 'FTD') return 'ftd';
    if (detail.type === 'Ground School') return 'ground';
    return 'flight';
};


const formatTime = (time: number) => {
    const hours = Math.floor(time);
    const minutes = Math.round((time % 1) * 60);
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
};

const convertTimeToDecimal = (timeStr: string): number => {
    if (!timeStr) return 0;
    const [hours, minutes] = timeStr.split(':').map(Number);
    if (isNaN(hours) || isNaN(minutes)) return 0;
    return hours + (minutes / 60);
};

export const EventDetailModal: React.FC<EventDetailModalProps> = ({ event, onClose, onSave, onDeleteRequest, isEditingDefault = false, instructors, trainees, syllabus, syllabusDetails, highlightedField, school, traineesData, instructorsData, courseColors, onNavigateToHateSheet, onNavigateToSyllabus, onOpenPt051, onOpenAuth, onOpenPostFlight, isConflict, onNeoClick, traineeLMPs, oracleContextForModal, sctRequests = [], sctEvents = [], eventsForDate = [], onScoresCreated, publishedSchedules = {}, nextDayBuildEvents = [], activeView = '', isAddingTile = false, formationCallsigns = [], currentLocation = '', onVisualAdjustStart, onVisualAdjustEnd, onSavePT051Assessment, cancellationCodes = [], onCancelEvent }) => {
    
    console.log('EventDetailModal opened - isAddingTile:', isAddingTile);
    console.log('Event data:', {
        eventCategory: event.eventCategory,
        flightType: event.flightType,
        instructor: event.instructor,
        student: event.student,
        pilot: event.pilot,
        isSct: event.isSct
    });

