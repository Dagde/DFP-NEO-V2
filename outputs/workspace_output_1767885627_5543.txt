
                const segmentSearchOrder = [...segments].sort((a, b) => a.count - b.count || a.start - b.start);
                let placed = false;
                const searchSpaces = (type === 'cpt' || type === 'ground') && !isNightPass && segments.length > 0 
                    ? segmentSearchOrder.map(s => ({ start: Math.max(searchStartTime, s.start), end: s.end }))
                    : [{ start: searchStartTime, end: endTimeBoundary }];

                for (const space of searchSpaces) {
                    if (placed) break;
                    for (let time = space.start; time <= space.end - syllabusItem.duration; time += timeIncrement) {
                        const result = scheduleEvent(trainee, syllabusItem, time, type, isNightPass, isPlusOne);
                        if (result && typeof result === 'object' && 'id' in result) {
                            generatedEvents.push(result);
                            // Only get instructor counts if not a solo flight
                               const ipCounts = result.instructor ? eventCounts.get(result.instructor)! : null;
                            const tCounts = eventCounts.get(trainee.fullName)!;
                            if (type === 'flight' || type === 'ftd') { 
                                tCounts.flightFtd++; 
                                if (ipCounts) ipCounts.flightFtd++; 
                            } else if (type === 'ground') { 
                                tCounts.ground++; 
                                if (ipCounts) ipCounts.ground++; // Count ground events for instructors
                            } else if (type === 'cpt') {
                                tCounts.cpt++; 
                                if (ipCounts) ipCounts.cpt++; // Count CPT events for instructors
                            }
                            
                            if (type === 'cpt' || type === 'ground') {
                                const segment = segments.find(s => time >= s.start && time < s.end);
                                if (segment) segment.count++;
                            }

                            placed = true;
--
        }

        // OLD STBY LOGIC REMOVED - Will be replaced with separate STBY pass after main build
    };
    
    type ScheduleEventResult = Omit<ScheduleEvent, 'date'> | null;
    
    const scheduleEvent = (
        trainee: Trainee,
        syllabusItem: SyllabusItemDetail,
        startTime: number,
